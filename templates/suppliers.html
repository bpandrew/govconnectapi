{% include "header.html" %}

<!-- [ content ] Start -->
<div class="container-fluid flex-grow-1 container-p-y" style="width: 98% !important;">
    <h4 class="font-weight-bold py-3 mb-0">Suppliers</h4>
    <div class="text-muted small mt-0 mb-4 d-block breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="#"><i class="feather icon-home"></i></a></li>
            <li class="breadcrumb-item active">Suppliers</li>
        </ol>
    </div>

    <!-- DataTable within card -->
    <div class="card">
        <div class="card-datatable table-responsive">
		<table id="ajaxTable" class="table table-hover card-table">
			<thead style="font-size:small">
				<tr>
					<th>Name</th>
					<th>ABN</th>
				</tr>
			</thead>
		</table>
        </div>
	</div>

</div>
<!-- [ content ] End -->




{% include "footer.html" %}

<script>
var myTable;
$(document).ready(function() {
	myTable = $("#ajaxTable").DataTable({
		"paging": true,
		"lengthChange": false,
		"searching": true,
		"ordering": true,
		"info": true
	});

	//alert(Date.now());
	//1565089793302
	//1565089802738

	if ( (localStorage.getItem("supplier_cache_time") === null) || (localStorage.getItem("supplier_cache_time") < Date.now()-30000 )) {
		localStorage.setItem("supplier_cache_time", Date.now());
		//alert("cache timeout");
		localStorage.setItem("supplier_page", 1);
		localStorage.setItem("supplier_data", JSON.stringify({"data":[]}));
	} else {
		
	}

	$.ajax({
		type: "POST",
		url: "/suppliers_data?page=1",
		contentType: "application/json; charset=utf-8",
		dataType: "json",
		success: function (response) {
			//var jsonObject = JSON.parse(response.data);
			var totalPages = response.pages;
			// If there is still pages to cache
			if (localStorage.getItem("supplier_page")<totalPages){
				console.log("Fetching new data");
				//alert("Fetching new data");
				for (i = 0; i < totalPages; i++) {
					PopulateItemsTable();
					page = localStorage.getItem("supplier_page");
					page++
					localStorage.setItem("supplier_page", page);
				}
			} else {
				//alert("Using old data");
				console.log("Using cached data");
				cached_data = JSON.parse(localStorage.getItem("supplier_data"));
				cached_data = cached_data.data
				//alert(cached_data[1]['link']);
				table_data = []
				var i;
				for (i = 0; i < cached_data.length; i++) { 
					table_data.push( [cached_data[i]['link'], cached_data[i]['abn']] )
					//myTable.rows.add(cached_data[i]); // add to DataTable instance
				}
				myTable.rows.add(table_data)
				myTable.draw();
			}

		}
	});
});


function PopulateItemsTable() {
	$.ajax({
		type: "POST",
		url: "/suppliers_data?page="+localStorage.getItem("supplier_page"),
		contentType: "application/json; charset=utf-8",
		dataType: "json",
		success: function (response) {
		//var jsonObject = JSON.parse(response.data);
		var totalPages = response.pages;
		var jsonObject = response.data;
		existing_storage = JSON.parse(localStorage.getItem("supplier_data"));
		
		//alert(existing_storage.data);
		//alert(jsonObject.length);
		index = 0;
		while (index < jsonObject.length) { 
			existing_storage['data'].push(jsonObject[index]);
			index++;
		}

		localStorage.setItem("supplier_data", JSON.stringify(existing_storage));
		//alert(localStorage.getItem("supplier_data"));
		var result = jsonObject.map(function(item){
			var result = [];
			result.push(item.link); 
			result.push(item.abn); 
			// .... add all the values required
			return result;
		});
		//console.log(result);
		myTable.rows.add(result); // add to DataTable instance
		myTable.draw(); // always redraw
		}
	});
}
</script>


<script>
	window.addEventListener('DOMContentLoaded', function(){
		//localStorage.setItem("cache_time", Date.now() );
		//localStorage.setItem("supplier_data", JSON.stringify({{ data_json|safe }}) );
		//_var = JSON.parse(localStorage.getItem("supplier_data"));
		//_var_date = localStorage.getItem("cache_time");
		//alert(_var[0]['id']);
		//alert(_var_date);
	});
</script>

	